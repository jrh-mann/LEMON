<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LEMON - Clinical Workflow Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="backdrop"></div>

    <div class="app-layout">
      <!-- Header -->
      <header class="app-header">
        <div class="logo">
          <span class="logo-mark">L</span>
          <span class="logo-text">LEMON</span>
        </div>
        <div class="header-actions">
          <button class="ghost" id="browseLibrary">Browse Library</button>
          <label class="ghost upload-label" for="imageUpload">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload Image
          </label>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
          <button class="primary" id="exportBtn" disabled>Export</button>
        </div>
      </header>

      <!-- Main workspace -->
      <main class="workspace">
        <!-- Left sidebar: Block palette -->
        <aside class="sidebar palette-sidebar">
          <div class="sidebar-section">
            <p class="eyebrow">BLOCKS</p>
            <div class="block-palette">
              <button class="palette-block" data-type="start" draggable="true">
                <div class="block-icon start-icon"></div>
                <span>Start</span>
              </button>
              <button class="palette-block" data-type="decision" draggable="true">
                <div class="block-icon decision-icon"></div>
                <span>Decision</span>
              </button>
              <button class="palette-block" data-type="output" draggable="true">
                <div class="block-icon output-icon"></div>
                <span>Output</span>
              </button>
              <button class="palette-block" data-type="subflow" draggable="true">
                <div class="block-icon subflow-icon"></div>
                <span>Subflow</span>
              </button>
            </div>
          </div>

        </aside>

        <!-- Center: Canvas -->
        <div class="canvas-area">
          <!-- Workspace tabs -->
          <div class="workspace-tabs" id="workspaceTabs">
            <!-- Tabs populated by JS -->
          </div>
          <div class="canvas-container" id="canvasContainer">
            <svg id="flowchartCanvas" viewBox="0 0 1200 800">
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="var(--ink)"></polygon>
                </marker>
                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                  <path d="M 40 0 L 0 0 0 40" fill="none" stroke="var(--edge)" stroke-width="0.5" opacity="0.5"/>
                </pattern>
              </defs>
              <rect width="100%" height="100%" fill="url(#grid)"/>
              <g id="imageLayer"></g>
              <g id="edgeLayer"></g>
              <g id="nodeLayer"></g>
            </svg>

            <!-- Empty state overlay -->
            <div class="canvas-empty" id="canvasEmpty">
              <div class="empty-content">
                <div class="empty-icon">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                </div>
                <h2>Start building</h2>
                <p>Drag blocks from the left, or describe your workflow below</p>
              </div>
            </div>

            <!-- Zoom controls -->
            <div class="zoom-controls">
              <button class="zoom-btn" id="zoomIn" title="Zoom in (+)">+</button>
              <button class="zoom-btn" id="zoomReset" title="Reset zoom (0)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>
                </svg>
              </button>
              <button class="zoom-btn" id="zoomOut" title="Zoom out (-)">-</button>
            </div>
          </div>

          <!-- Workflow info bar -->
          <div class="workflow-bar">
            <input type="text" id="workflowName" placeholder="Untitled workflow" class="workflow-name-input">
            <div class="workflow-meta">
              <span class="meta-item" id="blockCount">0 blocks</span>
              <span class="meta-item" id="validationScore" style="display: none;">
                <span class="score-dot"></span>
                <span id="scoreValue">0%</span> validated
              </span>
              <button class="meta-btn" id="autoArrangeBtn" title="Auto-arrange nodes">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"/>
                  <rect x="14" y="3" width="7" height="7"/>
                  <rect x="14" y="14" width="7" height="7"/>
                  <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Tidy
              </button>
            </div>
          </div>
        </div>

        <!-- Right sidebar: Library & Inputs -->
        <aside class="sidebar browser-sidebar" id="browserSidebar">
          <!-- Tab bar -->
          <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="library">Library</button>
            <button class="sidebar-tab" data-tab="inputs">Inputs</button>
          </div>

          <!-- Library panel -->
          <div class="sidebar-panel" id="libraryPanel" data-panel="library">
            <div class="browser-search">
              <input type="text" id="browserFilter" placeholder="Filter workflows..." autocomplete="off">
            </div>
            <!-- Semantic search status -->
            <div class="semantic-status" id="semanticStatus" style="display: none;">
              <div class="semantic-thinking">
                <div class="spinner-small"></div>
                <span id="semanticStatusText">Searching...</span>
              </div>
            </div>
            <div class="browser-list" id="browserList">
              <!-- Workflow cards loaded by JS -->
            </div>
            <div class="browser-empty" id="browserEmpty" style="display: none;">
              <p class="muted">No matches found.</p>
              <div class="semantic-search-trigger">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="M21 21l-4.35-4.35"/>
                </svg>
                Run Semantic Search
              </div>
            </div>
          </div>

          <!-- Inputs panel -->
          <div class="sidebar-panel hidden" id="inputsPanel" data-panel="inputs">
            <div class="inputs-empty" id="inputsEmpty">
              <p class="muted">No inputs defined.</p>
              <p class="muted small">Create or load a workflow to see its inputs.</p>
            </div>
            <div class="inputs-list" id="inputsList">
              <!-- Input items loaded by JS -->
            </div>
          </div>
        </aside>
      </main>

      <!-- Chat dock -->
      <div class="chat-dock" id="chatDock">
        <div class="chat-resize-handle" id="chatResizeHandle">
          <div class="resize-grip"></div>
        </div>
        <div class="chat-thread" id="chatThread">
          <div class="message assistant">
            <div class="message-content">
              <p>Hello! I'm your workflow assistant. You can:</p>
              <ul>
                <li><strong>Search workflows</strong> - "Find nephrology workflows" or "Show diabetes-related workflows"</li>
                <li><strong>Create new workflows</strong> - "Create a CKD staging workflow based on eGFR"</li>
                <li><strong>Ask questions</strong> - "What thresholds are used for diabetes diagnosis?"</li>
              </ul>
              <p>Browse the library on the right, or describe what you need below.</p>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-wrapper">
            <textarea id="chatInput" placeholder="Describe your workflow or ask a question..." rows="1"></textarea>
          </div>
          <button class="voice-btn" id="voiceBtn" title="Voice input">
            <svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            <svg class="stop-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
            <div class="voice-waves" style="display:none;">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
          </button>
          <button class="primary send-btn" id="sendBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Library modal -->
      <div class="modal" id="libraryModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h2>Workflow Library</h2>
            <button class="modal-close" id="closeLibrary">&times;</button>
          </div>
          <div class="modal-body">
            <div class="search-bar">
              <input type="text" id="librarySearch" placeholder="Search workflows...">
              <select id="libraryDomain">
                <option value="">All domains</option>
              </select>
            </div>
            <div class="library-grid" id="libraryGrid">
              <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Validation modal -->
      <div class="modal" id="validationModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content validation-content">
          <div class="modal-header">
            <div>
              <p class="eyebrow">VALIDATION SESSION</p>
              <h2 id="validationTitle">Validating workflow</h2>
            </div>
            <div class="validation-progress-header">
              <span id="validationProgress">0 / 0</span>
              <button class="modal-close" id="closeValidation">&times;</button>
            </div>
          </div>
          <div class="modal-body">
            <div class="validation-case" id="validationCase">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context menu for nodes -->
    <div class="context-menu" id="nodeContextMenu">
      <button class="context-menu-item" data-action="edit">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Edit
      </button>
      <button class="context-menu-item" data-action="delete">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
        Delete
      </button>
    </div>

    <!-- Context menu for edges -->
    <div class="context-menu" id="edgeContextMenu">
      <button class="context-menu-item" data-action="flip">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="17 1 21 5 17 9"/>
          <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
          <polyline points="7 23 3 19 7 15"/>
          <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
        </svg>
        Flip Direction
      </button>
      <button class="context-menu-item" data-action="editLabel">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Edit Label
      </button>
      <button class="context-menu-item" data-action="delete">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
        Delete
      </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
  </body>
</html>
